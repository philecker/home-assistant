blueprint:
  name: Camera Person Detection with Snapshot Notification
  description: Triggers a notification with a camera snapshot when a person is detected.
  domain: automation
  input:
    person_detection_sensor:
      name: Person Detection Sensor
      description: Select the binary sensor that turns ON when a person is detected.
      selector:
        entity:
          domain: binary_sensor
          device_class: motion # Often motion sensors are used for person detection
          multiple: false
    camera_entity_for_snapshot:
      name: Camera for Snapshot
      description: Select the camera entity to take the snapshot from.
      selector:
        entity:
          domain: camera
          multiple: false
    notify_target:
      name: Notification Target
      description: Select the device(s) or notification group to send the alert to.
      selector:
        target:
          entity:
            domain:
              - mobile_app
              - notify
    snapshot_base_path: # Renamed input for clarity
      name: Snapshot Base Path
      description: Base directory for snapshots (e.g., /config/www/snapshots/).
        Ensure this path is accessible by Home Assistant.
      default: /config/www/snapshots
      selector:
        text:
    notification_title:
      name: Notification Title
      description: Title for the notification.
      default: Person Detected!
      selector:
        text:
    notification_message:
      name: Notification Message
      description: Message content for the notification.
      default: A person has been detected by the camera.
      selector:
        text:

mode: single
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input person_detection_sensor
    to: 'on'

action:
  - variables:
      # Construct the dynamic filename: base_path/YYYY-MM-DD/camera_name_HHMMSS.jpg
      # Uses the current date for the folder, and the camera's friendly name (slugified)
      # and current time for the filename.
      generated_snapshot_filename: >
        {{ [
          (snapshot_base_path | default('/config/www/snapshots')),
          now().strftime('%Y-%m-%d'),
          (state_attr(camera_entity_for_snapshot, 'friendly_name') | slugify),
          (now().strftime('%H%M%S') + '.jpg')
        ] | join('/') }}
  - service: camera.snapshot
    data:
      entity_id: !input camera_entity_for_snapshot
      filename: "{{ generated_snapshot_filename }}"
  - delay:
      milliseconds: 500 # Give the snapshot a moment to save
  - service: notify.notify # Changed service to notify.notify for target selector
    # When using a 'target' selector, the 'notify.notify' service is generally
    # the correct one, and the 'target' input directly provides the entity IDs.
    target: !input notify_target
    data:
      title: !input notification_title
      message: "{{ notification_message }} from {{ states(camera_entity_for_snapshot) }}" # Message includes camera name
      data:
        image: "{{ generated_snapshot_filename }}" # Use the dynamically generated filename for the image attachment
