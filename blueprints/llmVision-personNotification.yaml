blueprint:
  name: Person Detected - Camera Notification + LLM Vision Remember
  description: >
    Sends a snapshot notification when motion is detected.
    Logs an event in LLM Vision using the camera entity.
    Only triggers if a person is detected.
  domain: automation
  input:
    motion_sensor:
      name: Motion Sensor
      selector:
        entity:
          domain: binary_sensor
    person_sensor:
      name: Person Detection Sensor (e.g. Frigate)
      selector:
        entity:
          domain: binary_sensor
    camera:
      name: Camera
      selector:
        entity:
          domain: camera
    camera_name:
      name: Camera Name
      selector:
        text:

trigger:
  - platform: state
    entity_id: !input motion_sensor
    to: "on"

variables:
  camera_entity: !input camera
  person_entity: !input person_sensor
  label: !input camera_name
  safe_label: "{{ label | lower | replace(' ', '_') | regex_replace('[^a-z0-9_]', '') }}"
  timestamp: "{{ now().strftime('%Y%m%d_%H%M%S') }}"
  snapshot_filename: "/config/www/snapshots/{{ safe_label }}/snapshot_{{ safe_label }}_{{ timestamp }}.jpg"
  snapshot_url: "/local/snapshots/{{ safe_label }}/snapshot_{{ safe_label }}_{{ timestamp }}.jpg"

condition: []

action:
  # 1️⃣ Ensure snapshot directory exists
  - service: shell_command.create_snapshot_dir
    data:
      dir: "/config/www/snapshots/{{ safe_label }}"

  # 2️⃣ Take snapshot for notifications
  - service: camera.snapshot
    data:
      filename: "{{ snapshot_filename }}"
    target:
      entity_id: !input camera

  # 3️⃣ Wait briefly to ensure file is saved
  - delay: "00:00:02"

  # 4️⃣ Debug: confirm snapshot saved
  - service: persistent_notification.create
    data:
      title: "Debug"
      message: "Snapshot saved at {{ snapshot_filename }}"

  # 5️⃣ Only log event in LLM Vision if person detected
  - if:
      - condition: state
        entity_id: !input person_sensor
        state: "on"
    then:
      - service: llmvision.remember
        data:
          title: "Person detected - {{ label }}"
          summary: ""
          image_entity: !input camera
          tags:
            - "{{ label }}"
            - "person"
          metadata:
            snapshot_url: "{{ snapshot_url }}"
            motion_entity: "{{ motion_sensor }}"
            detection_entity: "{{ person_entity }}"

      # Debug: confirm LLM Vision triggered
      - service: persistent_notification.create
        data:
          title: "Debug"
          message: "LLM Vision event logged for {{ camera_entity }}"

  # 6️⃣ Send notification if camera notifications toggle is on
  - if:
      - condition: state
        entity_id: input_boolean.camera_notifications
        state: "on"
    then:
      - service: notify.all_devices
        data:
          message: "Person Detected - {{ label | title }}"
          data:
            image: "{{ snapshot_url }}"
            actions:
              - action: "URI"
                title: "View Live"
                uri: "homeassistant://entity/{{ camera_entity }}"

mode: single
